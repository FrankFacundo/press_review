# LuxNews

Production-grade Luxembourg media monitoring with Selenium + CDP PDF export. The project searches predefined media endpoints, validates keyword matches on the rendered article, prints PDFs via Chrome DevTools Protocol, and provides a Streamlit workflow plus a CLI.

## Features
- Search Luxembourg media sites using the exact endpoints provided in this repo.
- Normalize keywords (case- and accent-insensitive) and validate matches using rendered article text.
- Export per-article PDFs via CDP `Page.printToPDF` and merge into a job PDF with a summary page.
- Streamlit frontend for daily runs and selector debugging.
- CLI for runs and debugging (search, article, selector playground).
- Debug toolkit for artifacts, selector playground, and headed DevTools mode.

## Install
```bash
python -m venv .venv
source .venv/bin/activate
pip install -e .
```

## CLI
Run default daily jobs (two runs):
```bash
luxnews run --config daily
```

Custom run:
```bash
luxnews run --keywords "BGL" --keywords "BNP PARIBAS" --medias rtl.lu --medias delano.lu --last-days 2
```
Repeat `--keywords`/`--medias` for multiple values.

Debug search:
```bash
luxnews debug-search --media rtl.lu --keyword BNP --last-days 2 --headed --pause
```

Debug article:
```bash
luxnews debug-article --url "https://example.com/article" --driver chrome --headed --open-devtools --pause-on-error
```

Selector playground:
```bash
luxnews selector-playground --html outputs/debug/<run_id>/rtl.lu/search/0001/page.html --css "article a"
luxnews selector-playground --url "https://rtl.lu/search?q=BNP" --xpath "//a[contains(@href,'/news/')]"
```
Selector playground with selectors file:
```bash
luxnews debug-selectors --selectors-file selectors.json --url "https://rtl.lu/search?q=BNP"
```
Example selectors file:
```json
{
  "css": "article a",
  "xpath": "//a[contains(@href,'news')]"
}
```

## Streamlit
Run the Streamlit UI:
```bash
streamlit run src/luxnews/streamlit_app.py
```

Or use the PyInstaller-friendly entry:
```bash
python run_streamlit.py
```

The UI provides:
- One-click daily jobs (two default runs)
- Advanced mode for custom keywords/medias, driver, headless toggle, output folder, and debug flags
- Progress and per-media status
- Downloads for merged PDFs and JSON outputs
- Selector Playground tab

## Outputs
Each job creates a run directory:
```
outputs/<run_id>/
  matches.json
  summary.pdf
  merged.pdf
  pdfs/
  debug/
```

## PDF Printing via CDP
`Page.printToPDF` is called via Selenium's `execute_cdp_cmd` on Chromium browsers (Chrome/Edge). The PDF is saved per article and then merged with a Run Summary page generated by reportlab.

## Debug Toolkit
### Artifact Dumping
When debug is enabled (`--debug` in CLI or UI checkbox), every search and article page stores artifacts under:
```
outputs/debug/<run_id>/<media>/<kind>/
```
Artifacts include HTML, MHTML (best-effort), full-page screenshot, console/performance logs (best-effort), and a debug bundle JSON with URL, timestamp, cookies (redacted), selector counts, title, and detected publish date.

Errors also store HTML and screenshot under:
```
outputs/errors/<run_id>/<media>/
```

### Selector Playground
Use CLI or Streamlit to run CSS/XPath selectors against:
- Offline HTML artifacts (BeautifulSoup/lxml)
- Live pages (Selenium)

Outputs include match counts and the first N elements' text and href. A JSON report can be saved with `--report`.

### Headed DevTools Mode
Use `--headed`, `--pause`, and `--pause-on-error` to keep the browser open for inspection. Add `--open-devtools` for Chromium to auto-open DevTools (best-effort). When a pause is active, the CLI prompts: `Press Enter to continue` so you can inspect the DOM manually.

For search artifacts, enable `--search-use-selenium` or `--debug` so search pages are rendered in Selenium and captured.

## Tests
Unit tests are offline. Live tests are opt-in:
```bash
pytest
RUN_LIVE_TESTS=1 pytest -m live
```

## CI
GitHub Actions runs lint-style checks (optional) and unit tests with coverage. Live tests are skipped.

## PyInstaller
Build scripts:
```bash
scripts/build_windows_exe.bat
scripts/build_linux_bin.sh
```
These produce a single binary that launches the Streamlit UI via `run_streamlit.py`.

## Selenium Troubleshooting
- Ensure Chrome or Edge is installed.
- If Selenium Manager cannot locate a browser, set `CHROME_BINARY` or `EDGE_BINARY` environment variables.
- Increase timeouts with `--page-timeout` or `--wait-timeout` if pages are slow.

## Terms and Robots
Respect each site's terms of service and robots.txt. This project is intended for internal monitoring and QA workflows.
